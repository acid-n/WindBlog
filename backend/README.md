# MUSSON Blog — Backend (Django 5, DRF)

[⬅️ Назад к корневому README](../README.md)

---

## Описание

Бэкенд-приложение для MUSSON Blog реализовано на **Django 5** с использованием **Django REST Framework** для API и **PostgreSQL** в качестве базы данных. Архитектура модульная, покрытие тестами Pytest >80%, поддержка Docker, OpenAPI/Swagger, кастомная модель пользователя, SEO, JWT.

---

## Основные технологии

- **Framework:** Django 5, Django REST Framework
- **База данных:** PostgreSQL (настраивается через переменные окружения)
- **Аутентификация:** JWT (`djangorestframework-simplejwt`), расширенная защита от брутфорс-атак, детальное логирование попыток авторизации
- **Документация API:** OpenAPI 3.0 (`drf-spectacular`)
- **Тестирование:** Pytest, pytest-django, factory_boy
- **Линтинг и форматирование:** Black, isort, Flake8 (pre-commit)
- **Развёртывание:** Dockerfile, поддержка gunicorn

---

## Структура проекта (`backend/`)

- `blog/`: Основное приложение блога (модели Post, Tag, Rating, ShortLink, сериализаторы, API ViewSets)
- `users/`: Кастомная модель пользователя (`CustomUser`), эндпоинты для регистрации/управления, middleware для защиты от брутфорс-атак
- `analytics/`: Модель AnalyticsEvent и API для сбора аналитики
- `contact/`: Модель ContactMessage и API для формы обратной связи
- `seo/`: SEO-функционал (robots.txt, sitemap.xml, OpenGraph)
- `config/`: Настройки Django (`settings.py`), корневые URL, WSGI/ASGI
- `management/commands/`: Кастомные manage.py команды (например, generate_test_data)
- `requirements.txt`: Зависимости
- `pytest.ini`: Конфиг Pytest
- `manage.py`: Django CLI
- `.env.example`: Пример переменных окружения
- `Dockerfile`: Инструкция для сборки образа

---

## Быстрый старт

### Локально (без Docker)

```bash
cd backend
python -m venv venv
source venv/bin/activate  # Linux/macOS
# venv\Scripts\activate    # Windows
pip install -r requirements.txt
cp .env.example .env  # Заполнить переменные
python manage.py migrate
python manage.py createsuperuser
python manage.py runserver
```

- Сервер: http://localhost:8000
- Swagger: http://localhost:8000/api/schema/

### Через Docker

```bash
cd .. # корень репозитория
docker-compose up --build
```

---

## Переменные окружения

- Все настройки вынесены в `.env` (см. `.env.example`)
- Важно: настройте параметры БД, DJANGO_SECRET_KEY и другие

---

## Тесты и линтинг

```bash
pytest          # Все тесты
pytest --cov    # Покрытие
flake8          # Линтинг
black .         # Форматирование
```

---

## Документация API (OpenAPI/Swagger)

- Swagger доступен по адресу http://localhost:8000/api/schema/
- Пример curl-запроса:

```bash
curl http://localhost:8000/api/v1/posts/
```

---

## FAQ
- **Как сгенерировать тестовые данные?**  
  `python manage.py generate_test_data`
- **Как добавить новое приложение?**  
  `python manage.py startapp <имя>` и зарегистрировать в settings.py
- **Как добавить эндпоинт в OpenAPI?**  
  Используйте DRF ViewSet + сериализатор, схема генерируется автоматически.

---

## Контакты
- Issues: [github.com/your-org/your-repo/issues](https://github.com/your-org/your-repo/issues)


## Безопасность

### Защита от брутфорс-атак

Реализован специальный middleware (`users.middleware.AuthRateLimitMiddleware`), который обеспечивает:
- **Rate limiting:** ограничение количества запросов к эндпоинтам авторизации (5 запросов в минуту)
- **Блокировка по IP:** временная блокировка IP-адреса после 5 неудачных попыток входа (на 15 минут)
- **Детальное логирование:** все попытки авторизации (успешные и неудачные) записываются в лог-файл `auth.log`
- **Защита конфиденциальности:** маскирование email-адресов в логах для соблюдения требований безопасности

Настройки защиты от брутфорс-атак (определены в `users/middleware.py`):
```python
MAX_FAILED_ATTEMPTS = 5  # Максимальное количество неудачных попыток
BLOCK_TIME = 15 * 60     # Время блокировки в секундах (15 минут)
```

### Аутентификация

- **Для получения/обновления JWT токенов:** `/api/token/`, `/api/token/refresh/`.
- **Защищенные эндпоинты** (например, создание/изменение постов и тегов) требуют `Bearer <JWT>` в заголовке `Authorization`.
- **Публичные эндпоинты** (например, чтение постов, тегов, архива) доступны без аутентификации (`IsAuthenticatedOrReadOnly` для ViewSet-ов).

### Логирование авторизации

Настроен специальный логгер `auth`, который записывает все попытки авторизации в отдельный файл `logs/auth.log`.
Примеры записей в логе:
- `INFO - Попытка авторизации: IP=192.168.1.1, Email=u****r@example.com`
- `INFO - Успешная авторизация: IP=192.168.1.1, Email=u****r@example.com`
- `WARNING - Неудачная авторизация: IP=192.168.1.2, Email=a****r@example.com, Код=401`
- `WARNING - Запрос заблокирован из-за превышения лимита попыток. IP: 192.168.1.2`

### Рекомендации по мониторингу

- Регулярно проверяйте файл `logs/auth.log` на наличие подозрительной активности
- Настройте внешнюю систему мониторинга для анализа логов и оповещения о множественных неудачных попытках входа
- Рассмотрите возможность добавления двухфакторной аутентификации для критически важных аккаунтов

## API

- **Базовый URL:** Все эндпоинты API доступны по префиксу `/api/v1/`.
- **Версионирование:** Используется версионирование v1.
- **Документация API (OpenAPI/Swagger):**
  - Интерактивная документация (Swagger UI): `/api/docs/`
  - Схема OpenAPI (JSON): `/api/schema/`
- **Формат ошибок:** При ошибках API возвращает JSON с полями `error` (тип ошибки) и `message` (описание), опционально `details`.

## Тестирование

- Используется Pytest с плагином `pytest-django` и `factory_boy` для генерации тестовых данных.
- Тесты расположены в директориях `tests/` внутри каждого Django-приложения (например, `blog/tests/`).
- **Запуск тестов:**
  Находясь в директории `backend/` (с активным виртуальным окружением, если не используется Docker):
  ```bash
  pytest
  ```
- Целевое покрытие тестами: >80%.
- Тесты автоматически запускаются в CI пайплайне.

## Линтинг и форматирование

- Код форматируется с помощью `black`.
- Импорты сортируются с помощью `isort`.
- Качество кода проверяется с помощью `flake8`.
- Эти инструменты настроены для автоматического запуска через pre-commit хуки (см. конфигурацию в корневом `.pre-commit-config.yaml`).

## Ключевые эндпоинты (примеры)

- `GET /api/v1/posts/` - Список постов (пагинированный). Также поддерживает параметр `?for_sitemap=true` для получения данных постов с SEO-атрибутами, необходимых для генерации `sitemap.xml` фронтендом.
- `GET /api/v1/posts/{slug}/` - Получение поста по slug.
- `POST /api/v1/posts/` - Создание нового поста (требуется аутентификация).
- `GET /api/v1/tags/` - Список тегов.
- `GET /api/v1/site-settings/` - Получение настроек сайта (название, описание).
- `GET /s/<code>/` - Редирект с короткой ссылки на соответствующий пост (если найден) или на главную страницу фронтенда.
- `/robots.txt` - Генерируется Django на основе правил из модели `RobotsRule` (приложение `seo`).

## Админ-панель Django

Доступна по адресу `/admin/` после запуска сервера. Используйте учетные данные суперпользователя.

## Замечания по разработке

- Придерживайтесь Git Flow (ветки `main`, `develop`, `feature/*`, `bugfix/*`).
- Все изменения в `develop` и `main` должны проходить через Pull Request и Code Review.
- Для новых фич и исправлений багов обязательно пишите тесты.

## Контакты

- По вопросам и предложениям: musson@support.ru
